<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis Finanzas</title>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Instrument+Serif&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { background: #162530; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #162530; }
    ::-webkit-scrollbar-thumb { background: #1f4a5c; border-radius: 3px; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ‚îÄ‚îÄ‚îÄ CONFIG SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Reemplaz√° estos valores con los tuyos de Supabase
    const SUPABASE_URL = "https://cvazbnthpsntqoatzswj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2YXpibnRocHNudHFvYXR6c3dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzkyMTMsImV4cCI6MjA4NzgxNTIxM30.KLevD2MfnMD0lndOhvngaG5JR76VKTBg_ofCmerRCRg";
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function getCurrentUser() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      return user;
    }

    async function loadData(uid) {
      if (SUPABASE_URL === "TU_SUPABASE_URL") return null;
      const { data, error } = await supabaseClient.from("finanzas").select("data").eq("id", uid).single();
      if (error || !data) return null;
      return data.data;
    }

    async function saveData(uid, payload) {
      if (SUPABASE_URL === "TU_SUPABASE_URL") return;
      await supabaseClient.from("finanzas").upsert({ id: uid, data: payload, updated_at: new Date().toISOString() });
    }

const { useState, useEffect, useCallback } = React;

const COLORS = {
  bg: "#162530",
  surface: "#1a3040",
  surfaceHover: "#1e3a4c",
  border: "#1f4a5c",
  accent: "#3ecfaa",
  accentDim: "#3ecfaa18",
  green: "#3ecfaa",
  greenDim: "#3ecfaa18",
  red: "#e07070",
  redDim: "#e0707015",
  blue: "#3ecfaa",
  blueDim: "#3ecfaa18",
  purple: "#5aacbf",
  purpleDim: "#5aacbf15",
  text: "#e8f2f5",
  textMuted: "#6a9aaa",
  textDim: "#1a3a4a",
};

const CATEGORY_ICONS = {
  "Vivienda": "üè†", "Alimentaci√≥n": "üõí", "Transporte": "üöó",
  "Salud": "üíä", "Entretenimiento": "üé¨", "Ropa": "üëó",
  "Educaci√≥n": "üìö", "Servicios": "üí°", "Pr√©stamo tarjeta": "üí≥", "Otros": "üì¶",
};

const MONTH_NAMES = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
const currentMonth = new Date().getMonth();
const currentYear = new Date().getFullYear();

const formatCurrency = (n) => {
  const abs = Math.abs(n);
  if (abs >= 1000000) return `$${(n/1000000).toFixed(1)}M`;
  if (abs >= 1000) return `$${(n/1000).toFixed(0)}K`;
  return `$${n.toFixed(0)}`;
};

const formatFull = (n) => `$${Number(n).toLocaleString("es-AR", { minimumFractionDigits: 0 })}`;

function Pill({ color, children }) {
  return (
    <span style={{
      background: color + "25", color, borderRadius: 20,
      padding: "2px 10px", fontSize: 12, fontWeight: 600,
    }}>{children}</span>
  );
}

function Card({ children, style = {} }) {
  return (
    <div style={{
      background: COLORS.surface,
      border: `1px solid ${COLORS.border}`,
      borderRadius: 18, padding: 24,
      boxShadow: "0 1px 8px #00000028",
      ...style,
    }}>{children}</div>
  );
}

function Button({ children, onClick, variant = "primary", size = "md", style = {} }) {
  const base = {
    cursor: "pointer", border: "none", borderRadius: 10, fontFamily: "inherit",
    fontWeight: 600, transition: "all .15s",
    padding: size === "sm" ? "6px 14px" : "10px 20px",
    fontSize: size === "sm" ? 13 : 14,
  };
  const variants = {
    primary: { background: "#3ecfaa", color: "#162530", boxShadow: "none" },
    ghost: { background: "transparent", color: COLORS.textMuted, border: `1px solid ${COLORS.border}` },
    danger: { background: COLORS.redDim, color: COLORS.red, border: `1px solid ${COLORS.red}40` },
  };
  return <button onClick={onClick} style={{ ...base, ...variants[variant], ...style }}>{children}</button>;
}

function Input({ label, value, onChange, type = "text", placeholder, prefix, options, style = {} }) {
  const inputStyle = {
    width: "100%", background: COLORS.bg, border: `1px solid ${COLORS.border}`,
    borderRadius: 8, padding: prefix ? "8px 12px 8px 28px" : "8px 12px",
    color: COLORS.text, fontFamily: "inherit", fontSize: 14, boxSizing: "border-box",
    outline: "none",
  };
  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 6, ...style }}>
      {label && <label style={{ fontSize: 12, color: COLORS.textMuted, fontWeight: 600, letterSpacing: ".5px", textTransform: "uppercase" }}>{label}</label>}
      <div style={{ position: "relative" }}>
        {prefix && <span style={{ position: "absolute", left: 10, top: "50%", transform: "translateY(-50%)", color: COLORS.textMuted, fontSize: 14 }}>{prefix}</span>}
        {options ? (
          <select value={value} onChange={e => onChange(e.target.value)} style={{ ...inputStyle, appearance: "none" }}>
            {options.map(o => <option key={o} value={o}>{o}</option>)}
          </select>
        ) : (
          <input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} style={inputStyle} />
        )}
      </div>
    </div>
  );
}

function ProgressBar({ value, max, color = COLORS.accent, height = 6 }) {
  const pct = max > 0 ? Math.min(100, (value / max) * 100) : 0;
  const barColor = pct > 90 ? COLORS.red : pct > 70 ? "#f59e0b" : color;
  return (
    <div style={{ background: COLORS.bg, borderRadius: 99, height, overflow: "hidden" }}>
      <div style={{ width: `${pct}%`, height: "100%", background: barColor, borderRadius: 99, transition: "width .4s ease" }} />
    </div>
  );
}

// ---- MONTH YEAR PICKER (custom, no browser select) ----
function MonthYearPicker({ selectedMonth, selectedYear, onChangeMonth, onChangeYear }) {
  const [openM, setOpenM] = useState(false);
  const [openY, setOpenY] = useState(false);
  const btnStyle = {
    background: "#162530", border: `1px solid #1f4a5c`, borderRadius: 8,
    color: "#e8f2f5", padding: "6px 14px", fontFamily: "inherit", fontSize: 13,
    cursor: "pointer", display: "flex", alignItems: "center", gap: 6, fontWeight: 500,
  };
  const dropStyle = {
    position: "absolute", top: "calc(100% + 4px)", right: 0, zIndex: 100,
    background: "#1a3040", border: `1px solid #1f4a5c`, borderRadius: 10,
    boxShadow: "0 8px 32px #00000060", padding: 6, minWidth: 120,
  };
  const optStyle = (active) => ({
    padding: "7px 14px", borderRadius: 6, cursor: "pointer", fontSize: 13,
    color: active ? "#162530" : "#e8f2f5",
    background: active ? "#3ecfaa" : "transparent",
    fontWeight: active ? 700 : 400,
  });
  return (
    <div style={{ display: "flex", gap: 8 }}>
      {/* Mes */}
      <div style={{ position: "relative" }}>
        <button onClick={() => { setOpenM(!openM); setOpenY(false); }} style={btnStyle}>
          {MONTH_NAMES[selectedMonth]} <span style={{ fontSize: 10, opacity: .6 }}>‚ñº</span>
        </button>
        {openM && (
          <div style={dropStyle}>
            {MONTH_NAMES.map((m, i) => (
              <div key={i} style={optStyle(i === selectedMonth)}
                onClick={() => { onChangeMonth(i); setOpenM(false); }}>
                {m}
              </div>
            ))}
          </div>
        )}
      </div>
      {/* A√±o */}
      <div style={{ position: "relative" }}>
        <button onClick={() => { setOpenY(!openY); setOpenM(false); }} style={btnStyle}>
          {selectedYear} <span style={{ fontSize: 10, opacity: .6 }}>‚ñº</span>
        </button>
        {openY && (
          <div style={dropStyle}>
            {[2023, 2024, 2025, 2026].map(y => (
              <div key={y} style={optStyle(y === selectedYear)}
                onClick={() => { onChangeYear(y); setOpenY(false); }}>
                {y}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

const TABS = ["Resumen", "Transacciones", "Presupuesto", "Ahorros", "Deudas", "Proyecci√≥n"];
const TAB_ICONS = ["üìä", "üí∏", "üéØ", "üê∑", "üí≥", "üìÖ"];

// ---- LOGIN SCREEN ----
function LoginScreen({ onLogin }) {
  const [mode, setMode] = useState("login"); // "login" | "register"
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState("");

  const inputStyle = {
    width: "100%", background: "#1a3040", border: `1px solid #1f4a5c`,
    borderRadius: 10, padding: "11px 14px", color: "#e8f2f5",
    fontFamily: "inherit", fontSize: 14, outline: "none",
  };

  const handleSubmit = async () => {
    setError(""); setSuccess(""); setLoading(true);
    try {
      if (mode === "register") {
        const { error } = await supabaseClient.auth.signUp({ email, password });
        if (error) throw error;
        setSuccess("¬°Cuenta creada! Revis√° tu email para confirmar y luego inici√° sesi√≥n.");
        setMode("login");
      } else {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        onLogin(data.user);
      }
    } catch (e) {
      setError(e.message || "Error al procesar la solicitud");
    }
    setLoading(false);
  };

  return (
    <div style={{ minHeight: "100vh", background: "#162530", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "'Geist', system-ui, sans-serif", padding: 16 }}>
      <div style={{ width: "100%", maxWidth: 400 }}>
        {/* Logo */}
        <div style={{ textAlign: "center", marginBottom: 36 }}>
          <div style={{ width: 60, height: 60, borderRadius: 16, background: "#3ecfaa", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 28, margin: "0 auto 16px" }}>üí∞</div>
          <div style={{ fontFamily: "'Instrument Serif', Georgia, serif", fontSize: 28, color: "#e8f2f5" }}>Mis Finanzas</div>
          <div style={{ fontSize: 13, color: "#6a9aaa", marginTop: 4 }}>Tu gestor financiero personal</div>
        </div>

        {/* Card */}
        <div style={{ background: "#1a3040", borderRadius: 18, padding: 32, border: "1px solid #1f4a5c", boxShadow: "0 8px 40px #00000040" }}>
          {/* Tabs */}
          <div style={{ display: "flex", marginBottom: 28, background: "#162530", borderRadius: 10, padding: 4 }}>
            {["login", "register"].map(m => (
              <button key={m} onClick={() => { setMode(m); setError(""); setSuccess(""); }} style={{
                flex: 1, padding: "8px", borderRadius: 8, border: "none", cursor: "pointer",
                fontFamily: "inherit", fontSize: 13, fontWeight: 600, transition: "all .2s",
                background: mode === m ? "#3ecfaa" : "transparent",
                color: mode === m ? "#162530" : "#6a9aaa",
              }}>
                {m === "login" ? "Iniciar sesi√≥n" : "Registrarse"}
              </button>
            ))}
          </div>

          {/* Fields */}
          <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
            <div>
              <div style={{ fontSize: 12, color: "#6a9aaa", fontWeight: 600, marginBottom: 6, textTransform: "uppercase", letterSpacing: ".5px" }}>Email</div>
              <input type="email" value={email} onChange={e => setEmail(e.target.value)}
                placeholder="tu@email.com" style={inputStyle}
                onKeyDown={e => e.key === "Enter" && handleSubmit()} />
            </div>
            <div>
              <div style={{ fontSize: 12, color: "#6a9aaa", fontWeight: 600, marginBottom: 6, textTransform: "uppercase", letterSpacing: ".5px" }}>Contrase√±a</div>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)}
                placeholder="M√≠nimo 6 caracteres" style={inputStyle}
                onKeyDown={e => e.key === "Enter" && handleSubmit()} />
            </div>

            {error && <div style={{ background: "#e0707015", border: "1px solid #e0707040", borderRadius: 8, padding: "10px 14px", fontSize: 13, color: "#e07070" }}>{error}</div>}
            {success && <div style={{ background: "#3ecfaa15", border: "1px solid #3ecfaa40", borderRadius: 8, padding: "10px 14px", fontSize: 13, color: "#3ecfaa" }}>{success}</div>}

            <button onClick={handleSubmit} disabled={loading} style={{
              background: loading ? "#1f4a5c" : "#3ecfaa", color: loading ? "#6a9aaa" : "#162530",
              border: "none", borderRadius: 10, padding: "12px", fontFamily: "inherit",
              fontSize: 15, fontWeight: 700, cursor: loading ? "not-allowed" : "pointer",
              marginTop: 4, transition: "all .2s",
            }}>
              {loading ? "Procesando..." : mode === "login" ? "Entrar" : "Crear cuenta"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ---- MAIN APP ----
function FinanzasApp() {
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [tab, setTab] = useState(0);
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);

  const defaultData = {
    transactions: [],
    budgets: Object.keys(CATEGORY_ICONS).map(cat => ({ cat, limit: 0 })),
    savings: [],
    debts: [],
    selectedMonth: currentMonth,
    selectedYear: currentYear,
  };

  // Check existing session on mount
  useEffect(() => {
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user || null);
      setAuthLoading(false);
    });
    const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user || null);
    });
    return () => subscription.unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    async function load() {
      try {
        const d = await loadData(user.id);
        setData(d || defaultData);
      } catch {
        setData(defaultData);
      }
      setLoading(false);
    }
    load();
  }, [user]);

  const save = useCallback(async (newData) => {
    setData(newData);
    try { await saveData(user.id, newData); } catch {}
  }, [user]);

  const logout = async () => {
    await supabaseClient.auth.signOut();
    setUser(null);
    setData(null);
    setLoading(true);
  };

  if (authLoading) return (
    <div style={{ minHeight: "100vh", background: "#162530", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ color: "#6a9aaa", fontFamily: "Georgia, serif", fontSize: 18 }}>Cargando...</div>
    </div>
  );

  if (!user) return <LoginScreen onLogin={setUser} />;

  if (loading) return (
    <div style={{ minHeight: "100vh", background: COLORS.bg, display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ color: COLORS.textMuted, fontFamily: "Georgia, serif", fontSize: 18 }}>Cargando tus finanzas...</div>
    </div>
  );

  const monthTxs = data.transactions.filter(t =>
    new Date(t.date).getMonth() === data.selectedMonth &&
    new Date(t.date).getFullYear() === data.selectedYear
  );
  const totalIncome = monthTxs.filter(t => t.type === "ingreso").reduce((s, t) => s + t.amount, 0);
  const totalExpense = monthTxs.filter(t => t.type === "gasto").reduce((s, t) => s + t.amount, 0);
  const balance = totalIncome - totalExpense;

  const expByCat = {};
  monthTxs.filter(t => t.type === "gasto").forEach(t => {
    expByCat[t.category] = (expByCat[t.category] || 0) + t.amount;
  });

  const totalDebt = data.debts.reduce((s, d) => s + d.remaining, 0);
  const totalSavings = data.savings.reduce((s, g) => s + g.current, 0);

  return (
    <div style={{ minHeight: "100vh", background: COLORS.bg, fontFamily: "'Geist', 'Inter', system-ui, sans-serif", color: COLORS.text }}>
      <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Instrument+Serif&display=swap" rel="stylesheet" />

      {/* Header */}
      <div style={{ background: "#1a3040", borderBottom: `1px solid ${COLORS.border}`, padding: "16px 24px", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 38, height: 38, borderRadius: 10, background: "#3ecfaa", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18 }}>üí∞</div>
          <div>
            <div style={{ fontFamily: "'Instrument Serif', Georgia, serif", fontSize: 22, color: COLORS.text, fontWeight: 400 }}>
              Mis Finanzas
            </div>
            <div style={{ fontSize: 12, color: COLORS.textMuted, marginTop: 1 }}>
              {MONTH_NAMES[data.selectedMonth]} {data.selectedYear}
            </div>
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <MonthYearPicker
            selectedMonth={data.selectedMonth}
            selectedYear={data.selectedYear}
            onChangeMonth={m => save({ ...data, selectedMonth: m })}
            onChangeYear={y => save({ ...data, selectedYear: y })}
          />
          <div style={{ fontSize: 12, color: COLORS.textMuted, maxWidth: 140, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", display: "none" }}>{user?.email}</div>
          <button onClick={logout} title={user?.email} style={{ background: "#162530", border: `1px solid #1f4a5c`, borderRadius: 8, color: COLORS.textMuted, padding: "6px 12px", fontFamily: "inherit", fontSize: 13, cursor: "pointer" }}>
            Salir
          </button>
        </div>
      </div>


      {/* Tab bar */}
      <div style={{ display: "flex", borderBottom: `1px solid ${COLORS.border}`, background: COLORS.surface, paddingLeft: 20, gap: 2 }}>
        {TABS.map((t, i) => (
          <button key={t} onClick={() => setTab(i)} style={{
            background: tab === i ? `${COLORS.accent}12` : "none",
            border: "none", cursor: "pointer", fontFamily: "inherit",
            color: tab === i ? COLORS.accent : COLORS.textMuted,
            padding: "13px 18px", fontSize: 13, fontWeight: tab === i ? 700 : 500,
            borderBottom: tab === i ? `2px solid ${COLORS.accent}` : "2px solid transparent",
            borderRadius: "8px 8px 0 0",
            transition: "all .2s", letterSpacing: tab === i ? "0px" : "0px",
          }}>
            {TAB_ICONS[i]} {t}
          </button>
        ))}
      </div>

      <div style={{ maxWidth: 960, margin: "0 auto", padding: "24px 16px" }}>
        {tab === 0 && <Resumen balance={balance} totalIncome={totalIncome} totalExpense={totalExpense} totalDebt={totalDebt} totalSavings={totalSavings} monthTxs={monthTxs} expByCat={expByCat} data={data} />}
        {tab === 1 && <Transacciones data={data} save={save} monthTxs={monthTxs} />}
        {tab === 2 && <Presupuesto data={data} save={save} expByCat={expByCat} />}
        {tab === 3 && <Ahorros data={data} save={save} />}
        {tab === 4 && <Deudas data={data} save={save} />}
        {tab === 5 && <Proyeccion data={data} />}
      </div>
    </div>
  );
}

// ---- RESUMEN ----
function Resumen({ balance, totalIncome, totalExpense, totalDebt, totalSavings, monthTxs, expByCat, data }) {
  const topCats = Object.entries(expByCat).sort((a,b) => b[1]-a[1]).slice(0, 4);

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
      {/* KPIs */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: 16 }}>
        {[
          { label: "Balance del mes", value: balance, color: COLORS.text, icon: "‚öñÔ∏è" },
          { label: "Ingresos", value: totalIncome, color: COLORS.text, icon: "üìà" },
          { label: "Gastos", value: totalExpense, color: COLORS.text, icon: "üìâ" },
          { label: "Deuda total", value: totalDebt, color: COLORS.text, icon: "üí≥" },
          { label: "Ahorros", value: totalSavings, color: COLORS.text, icon: "üê∑" },
        ].map(k => (
          <Card key={k.label} style={{ display: "flex", flexDirection: "column", gap: 8 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 12, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px" }}>{k.label}</span>
              <span>{k.icon}</span>
            </div>
            <div style={{ fontSize: 28, fontWeight: 700, color: k.color, fontFamily: "'Instrument Serif', Georgia, serif" }}>
              {formatFull(k.value)}
            </div>
          </Card>
        ))}
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        {/* Top gastos */}
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16, fontSize: 15 }}>üî• Top gastos del mes</div>
          {topCats.length === 0 ? (
            <div style={{ color: COLORS.textMuted, fontSize: 13 }}>Sin gastos registrados a√∫n.</div>
          ) : topCats.map(([cat, amt]) => (
            <div key={cat} style={{ marginBottom: 14 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6, fontSize: 13 }}>
                <span>{CATEGORY_ICONS[cat] || "üì¶"} {cat}</span>
                <span style={{ color: COLORS.text, fontWeight: 600 }}>{formatFull(amt)}</span>
              </div>
              <ProgressBar value={amt} max={totalExpense || 1} color={COLORS.accent} />
            </div>
          ))}
        </Card>

        {/* √öltimas transacciones */}
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16, fontSize: 15 }}>üïê √öltimas transacciones</div>
          {monthTxs.length === 0 ? (
            <div style={{ color: COLORS.textMuted, fontSize: 13 }}>Sin transacciones este mes.</div>
          ) : [...monthTxs].reverse().slice(0, 6).map(t => (
            <div key={t.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "8px 0", borderBottom: `1px solid ${COLORS.border}` }}>
              <div>
                <div style={{ fontSize: 13, fontWeight: 500 }}>{t.description || t.category}</div>
                <div style={{ fontSize: 11, color: COLORS.textMuted }}>{t.date} ¬∑ {t.category}</div>
              </div>
              <span style={{ fontWeight: 700, color: COLORS.text, fontSize: 14 }}>
                {t.type === "ingreso" ? "+" : "-"}{formatFull(t.amount)}
              </span>
            </div>
          ))}
        </Card>
      </div>

      {/* Savings goals preview */}
      {data.savings.length > 0 && (
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16, fontSize: 15 }}>üéØ Metas de ahorro</div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: 16 }}>
            {data.savings.map(g => {
              const pct = g.goal > 0 ? Math.min(100, (g.current / g.goal) * 100) : 0;
              return (
                <div key={g.id} style={{ background: COLORS.bg, borderRadius: 12, padding: 16, border: `1px solid ${COLORS.border}` }}>
                  <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 8 }}>{g.name}</div>
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, color: COLORS.textMuted, marginBottom: 6 }}>
                    <span>{formatFull(g.current)}</span>
                    <span>{formatFull(g.goal)}</span>
                  </div>
                  <ProgressBar value={g.current} max={g.goal} color={COLORS.accent} />
                  <div style={{ fontSize: 12, color: COLORS.textMuted, marginTop: 6, fontWeight: 600 }}>{pct.toFixed(0)}% completado</div>
                </div>
              );
            })}
          </div>
        </Card>
      )}
    </div>
  );
}

// ---- TRANSACCIONES ----
function Transacciones({ data, save, monthTxs }) {
  const [form, setForm] = useState({ type: "gasto", amount: "", category: "Alimentaci√≥n", description: "", date: new Date().toISOString().split("T")[0] });
  const [showForm, setShowForm] = useState(false);

  const add = () => {
    if (!form.amount || isNaN(form.amount)) return;
    const tx = { ...form, amount: parseFloat(form.amount), id: Date.now() };
    save({ ...data, transactions: [...data.transactions, tx] });
    setForm({ type: "gasto", amount: "", category: "Alimentaci√≥n", description: "", date: new Date().toISOString().split("T")[0] });
    setShowForm(false);
  };

  const del = (id) => save({ ...data, transactions: data.transactions.filter(t => t.id !== id) });

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <div style={{ display: "flex", justifyContent: "flex-end" }}>
        <Button onClick={() => setShowForm(!showForm)}>{showForm ? "‚úï Cancelar" : "+ Nueva transacci√≥n"}</Button>
      </div>

      {showForm && (
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16 }}>Nueva transacci√≥n</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 12 }}>
            <Input label="Tipo" value={form.type} onChange={v => setForm({ ...form, type: v })} options={["gasto", "ingreso"]} />
            <Input label="Monto" value={form.amount} onChange={v => setForm({ ...form, amount: v })} type="number" prefix="$" placeholder="0" />
            <Input label="Categor√≠a" value={form.category} onChange={v => setForm({ ...form, category: v })} options={Object.keys(CATEGORY_ICONS)} />
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
            <Input label="Descripci√≥n" value={form.description} onChange={v => setForm({ ...form, description: v })} placeholder="ej. Supermercado" />
            <Input label="Fecha" value={form.date} onChange={v => setForm({ ...form, date: v })} type="date" />
          </div>
          <Button onClick={add}>Guardar transacci√≥n</Button>
        </Card>
      )}

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <div style={{ padding: "16px 20px", borderBottom: `1px solid ${COLORS.border}`, fontWeight: 700, fontSize: 15 }}>
          Transacciones ‚Äî {["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][data.selectedMonth]} {data.selectedYear}
        </div>
        {monthTxs.length === 0 ? (
          <div style={{ padding: 32, textAlign: "center", color: COLORS.textMuted }}>Sin transacciones este mes. ¬°Agreg√° la primera!</div>
        ) : (
          [...monthTxs].reverse().map(t => (
            <div key={t.id} style={{ display: "flex", alignItems: "center", padding: "14px 20px", borderBottom: `1px solid ${COLORS.border}`, gap: 12 }}>
              <div style={{ width: 36, height: 36, borderRadius: 10, background: t.type === "ingreso" ? COLORS.greenDim : COLORS.redDim, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>
                {CATEGORY_ICONS[t.category] || "üì¶"}
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: 500, fontSize: 14 }}>{t.description || t.category}</div>
                <div style={{ fontSize: 12, color: COLORS.textMuted }}>{t.date} ¬∑ {t.category}</div>
              </div>
              <div style={{ fontWeight: 700, fontSize: 16, color: t.type === "ingreso" ? COLORS.green : COLORS.red }}>
                {t.type === "ingreso" ? "+" : "-"}{formatFull(t.amount)}
              </div>
              <button onClick={() => del(t.id)} style={{ background: "none", border: "none", cursor: "pointer", color: COLORS.textDim, fontSize: 16, padding: 4 }}>‚úï</button>
            </div>
          ))
        )}
      </Card>
    </div>
  );
}

// ---- PRESUPUESTO ----
function Presupuesto({ data, save, expByCat }) {
  const updateLimit = (cat, val) => {
    const budgets = data.budgets.map(b => b.cat === cat ? { ...b, limit: parseFloat(val) || 0 } : b);
    save({ ...data, budgets });
  };

  const totalBudget = data.budgets.reduce((s, b) => s + b.limit, 0);
  const totalSpent = Object.values(expByCat).reduce((s, v) => s + v, 0);

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <Card>
          <div style={{ fontSize: 12, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px", marginBottom: 6 }}>Presupuesto total</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: COLORS.text, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(totalBudget)}</div>
        </Card>
        <Card>
          <div style={{ fontSize: 12, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px", marginBottom: 6 }}>Gastado este mes</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: COLORS.text, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(totalSpent)}</div>
        </Card>
      </div>

      <Card>
        <div style={{ fontWeight: 700, marginBottom: 20, fontSize: 15 }}>L√≠mites por categor√≠a</div>
        <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>
          {data.budgets.map(b => {
            const spent = expByCat[b.cat] || 0;
            const pct = b.limit > 0 ? Math.min(100, (spent / b.limit) * 100) : 0;
            return (
              <div key={b.cat}>
                <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 8 }}>
                  <span style={{ fontSize: 20 }}>{CATEGORY_ICONS[b.cat]}</span>
                  <div style={{ flex: 1 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                      <span style={{ fontSize: 14, fontWeight: 600 }}>{b.cat}</span>
                      <span style={{ fontSize: 13, color: COLORS.textMuted }}>
                        {formatFull(spent)} / {b.limit > 0 ? formatFull(b.limit) : "sin l√≠mite"}
                      </span>
                    </div>
                    <ProgressBar value={spent} max={b.limit || 1} />
                  </div>
                  <input
                    type="number"
                    value={b.limit || ""}
                    onChange={e => updateLimit(b.cat, e.target.value)}
                    placeholder="L√≠mite"
                    style={{ width: 90, background: COLORS.bg, border: `1px solid ${COLORS.border}`, borderRadius: 8, padding: "5px 8px", color: COLORS.text, fontFamily: "inherit", fontSize: 13, textAlign: "right" }}
                  />
                </div>
              </div>
            );
          })}
        </div>
      </Card>
    </div>
  );
}

// ---- AHORROS ----
function Ahorros({ data, save }) {
  const [form, setForm] = useState({ name: "", goal: "", current: "" });
  const [addAmt, setAddAmt] = useState({});
  const [showForm, setShowForm] = useState(false);

  const add = () => {
    if (!form.name || !form.goal) return;
    const g = { name: form.name, goal: parseFloat(form.goal), current: parseFloat(form.current) || 0, id: Date.now() };
    save({ ...data, savings: [...data.savings, g] });
    setForm({ name: "", goal: "", current: "" });
    setShowForm(false);
  };

  const addToSaving = (id) => {
    const amt = parseFloat(addAmt[id] || 0);
    if (!amt) return;
    const savings = data.savings.map(g => g.id === id ? { ...g, current: g.current + amt } : g);
    save({ ...data, savings });
    setAddAmt({ ...addAmt, [id]: "" });
  };

  const del = (id) => save({ ...data, savings: data.savings.filter(g => g.id !== id) });

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <div style={{ display: "flex", justifyContent: "flex-end" }}>
        <Button onClick={() => setShowForm(!showForm)}>{showForm ? "‚úï Cancelar" : "+ Nueva meta"}</Button>
      </div>
      {showForm && (
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16 }}>Nueva meta de ahorro</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 16 }}>
            <Input label="Nombre de la meta" value={form.name} onChange={v => setForm({ ...form, name: v })} placeholder="ej. Vacaciones" />
            <Input label="Meta total" value={form.goal} onChange={v => setForm({ ...form, goal: v })} type="number" prefix="$" placeholder="100000" />
            <Input label="Ya tengo" value={form.current} onChange={v => setForm({ ...form, current: v })} type="number" prefix="$" placeholder="0" />
          </div>
          <Button onClick={add}>Crear meta</Button>
        </Card>
      )}

      {data.savings.length === 0 ? (
        <Card style={{ textAlign: "center", padding: 48 }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>üê∑</div>
          <div style={{ color: COLORS.textMuted }}>No ten√©s metas de ahorro a√∫n.</div>
        </Card>
      ) : (
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 16 }}>
          {data.savings.map(g => {
            const pct = g.goal > 0 ? Math.min(100, (g.current / g.goal) * 100) : 0;
            const remaining = Math.max(0, g.goal - g.current);
            return (
              <Card key={g.id}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
                  <div style={{ fontWeight: 700, fontSize: 16 }}>{g.name}</div>
                  <button onClick={() => del(g.id)} style={{ background: "none", border: "none", cursor: "pointer", color: COLORS.textDim }}>‚úï</button>
                </div>
                <div style={{ marginBottom: 8 }}>
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, color: COLORS.textMuted, marginBottom: 8 }}>
                    <span>Ahorrado: <strong>{formatFull(g.current)}</strong></span>
                    <span>Meta: <strong style={{ color: COLORS.text }}>{formatFull(g.goal)}</strong></span>
                  </div>
                  <ProgressBar value={g.current} max={g.goal} color={COLORS.accent} height={10} />
                  <div style={{ fontSize: 13, color: COLORS.textMuted, marginTop: 8 }}>
                    {pct.toFixed(1)}% ¬∑ Falta {formatFull(remaining)}
                  </div>
                </div>
                <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
                  <input
                    type="number"
                    value={addAmt[g.id] || ""}
                    onChange={e => setAddAmt({ ...addAmt, [g.id]: e.target.value })}
                    placeholder="Agregar monto..."
                    style={{ flex: 1, background: COLORS.bg, border: `1px solid ${COLORS.border}`, borderRadius: 8, padding: "7px 10px", color: COLORS.text, fontFamily: "inherit", fontSize: 13 }}
                  />
                  <Button onClick={() => addToSaving(g.id)} size="sm">+ Agregar</Button>
                </div>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ---- DEUDAS ----
function Deudas({ data, save }) {
  const [form, setForm] = useState({ name: "", total: "", remaining: "", installment: "", remainingInstallments: "", dueDay: "", interest: "" });
  const [showForm, setShowForm] = useState(false);
  const [payAmt, setPayAmt] = useState({});

  const add = () => {
    if (!form.name || !form.remaining) return;
    const installment = parseFloat(form.installment) || 0;
    const remainingInstallments = parseInt(form.remainingInstallments) || (installment > 0 ? Math.ceil(parseFloat(form.remaining) / installment) : 0);
    const d = {
      name: form.name,
      total: parseFloat(form.total) || parseFloat(form.remaining),
      remaining: parseFloat(form.remaining),
      installment,
      remainingInstallments,
      dueDay: parseInt(form.dueDay) || 1,
      interest: parseFloat(form.interest) || 0,
      startMonth: new Date().getMonth(),
      startYear: new Date().getFullYear(),
      id: Date.now(),
    };
    save({ ...data, debts: [...data.debts, d] });
    setForm({ name: "", total: "", remaining: "", installment: "", remainingInstallments: "", dueDay: "", interest: "" });
    setShowForm(false);
  };

  const pay = (id) => {
    const amt = parseFloat(payAmt[id] || 0);
    if (!amt) return;
    const debts = data.debts.map(d => d.id === id ? { ...d, remaining: Math.max(0, d.remaining - amt) } : d);
    save({ ...data, debts });
    setPayAmt({ ...payAmt, [id]: "" });
  };

  const del = (id) => save({ ...data, debts: data.debts.filter(d => d.id !== id) });

  const totalDebt = data.debts.reduce((s, d) => s + d.remaining, 0);
  const monthlyPayments = data.debts.reduce((s, d) => s + d.installment, 0);

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", gap: 12 }}>
          <Card style={{ padding: "12px 20px" }}>
            <div style={{ fontSize: 11, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", marginBottom: 4 }}>Deuda total</div>
            <div style={{ fontSize: 22, fontWeight: 700, color: COLORS.text, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(totalDebt)}</div>
          </Card>
          {monthlyPayments > 0 && (
            <Card style={{ padding: "12px 20px" }}>
              <div style={{ fontSize: 11, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", marginBottom: 4 }}>Cuotas mensuales</div>
              <div style={{ fontSize: 22, fontWeight: 700, color: COLORS.text, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(monthlyPayments)}</div>
            </Card>
          )}
        </div>
        <Button onClick={() => setShowForm(!showForm)}>{showForm ? "‚úï Cancelar" : "+ Nueva deuda"}</Button>
      </div>

      {showForm && (
        <Card>
          <div style={{ fontWeight: 700, marginBottom: 16 }}>Nueva deuda</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 12 }}>
            <Input label="Nombre / Acreedor" value={form.name} onChange={v => setForm({ ...form, name: v })} placeholder="ej. Tarjeta Visa" />
            <Input label="Deuda total original" value={form.total} onChange={v => setForm({ ...form, total: v })} type="number" prefix="$" placeholder="0" />
            <Input label="Saldo restante" value={form.remaining} onChange={v => setForm({ ...form, remaining: v })} type="number" prefix="$" placeholder="0" />
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 12, marginBottom: 16 }}>
            <Input label="Cuota mensual" value={form.installment} onChange={v => setForm({ ...form, installment: v })} type="number" prefix="$" placeholder="0" />
            <Input label="Cuotas restantes" value={form.remainingInstallments} onChange={v => setForm({ ...form, remainingInstallments: v })} type="number" placeholder="ej. 9" />
            <Input label="D√≠a de vencimiento" value={form.dueDay} onChange={v => setForm({ ...form, dueDay: v })} type="number" placeholder="1-31" />
            <Input label="Inter√©s mensual (%)" value={form.interest} onChange={v => setForm({ ...form, interest: v })} type="number" placeholder="0" />
          </div>
          <Button onClick={add}>Agregar deuda</Button>
        </Card>
      )}

      {data.debts.length === 0 ? (
        <Card style={{ textAlign: "center", padding: 48 }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>üéâ</div>
          <div style={{ color: COLORS.textMuted }}>¬°Sin deudas registradas! Si ten√©s, pod√©s agregarlas arriba.</div>
        </Card>
      ) : (
        <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
          {data.debts.map(d => {
            const pct = d.total > 0 ? Math.min(100, ((d.total - d.remaining) / d.total) * 100) : 0;
            return (
              <Card key={d.id}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                  <div>
                    <div style={{ fontWeight: 700, fontSize: 15 }}>üí≥ {d.name}</div>
                    <div style={{ fontSize: 12, color: COLORS.textMuted, marginTop: 2 }}>
                      {d.dueDay ? `Vence d√≠a ${d.dueDay}` : ""}
                      {d.interest > 0 ? ` ¬∑ ${d.interest}% mensual` : ""}
                    </div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 22, fontWeight: 700, color: COLORS.text, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(d.remaining)}</div>
                    <div style={{ fontSize: 12, color: COLORS.textMuted }}>de {formatFull(d.total)}</div>
                  </div>
                </div>
                <ProgressBar value={d.total - d.remaining} max={d.total || 1} color={COLORS.accent} height={8} />
                <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, color: COLORS.textMuted, marginTop: 6, marginBottom: 16 }}>
                  <span style={{ color: COLORS.textMuted }}>{pct.toFixed(0)}% pagado</span>
                  <div style={{ display: "flex", gap: 12 }}>
                    {d.installment > 0 && <span>Cuota: <strong style={{ color: COLORS.text }}>{formatFull(d.installment)}</strong>/mes</span>}
                    {d.remainingInstallments > 0 && <span>Cuotas restantes: <strong style={{ color: COLORS.text }}>{d.remainingInstallments}</strong></span>}
                  </div>
                </div>
                <div style={{ display: "flex", gap: 8 }}>
                  <input
                    type="number"
                    value={payAmt[d.id] || ""}
                    onChange={e => setPayAmt({ ...payAmt, [d.id]: e.target.value })}
                    placeholder="Monto a pagar..."
                    style={{ flex: 1, background: COLORS.bg, border: `1px solid ${COLORS.border}`, borderRadius: 8, padding: "7px 10px", color: COLORS.text, fontFamily: "inherit", fontSize: 13 }}
                  />
                  <Button onClick={() => pay(d.id)} size="sm">üí∏ Pagar</Button>
                  <Button onClick={() => del(d.id)} variant="danger" size="sm">Eliminar</Button>
                </div>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ---- PROYECCI√ìN 12 MESES ----
function Proyeccion({ data }) {
  const now = new Date();
  const startMonth = now.getMonth();
  const startYear = now.getFullYear();
  const [expandido, setExpandido] = useState(null);

  // Promedio de ingresos de los √∫ltimos 3 meses
  const avgIncome = (() => {
    const totals = [];
    for (let i = 0; i < 3; i++) {
      let m = startMonth - i; let y = startYear;
      if (m < 0) { m += 12; y--; }
      const inc = data.transactions
        .filter(t => t.type === "ingreso" && new Date(t.date).getMonth() === m && new Date(t.date).getFullYear() === y)
        .reduce((s, t) => s + t.amount, 0);
      if (inc > 0) totals.push(inc);
    }
    return totals.length > 0 ? totals.reduce((a, b) => a + b, 0) / totals.length : 0;
  })();

  // Categor√≠as de presupuesto con l√≠mite > 0
  const budgetItems = data.budgets.filter(b => b.limit > 0);
  const budgetTotal = budgetItems.reduce((s, b) => s + b.limit, 0);

  // Colores para cuotas
  const DEBT_COLORS = ["#5aacbf","#3ecfaa","#f472b6","#fb923c","#3ecfaa","#fbbf24","#22d3ee"];
  const activeDebts = data.debts.filter(d => d.installment > 0 && d.remainingInstallments > 0);

  // Calcular 12 meses
  const months = Array.from({ length: 12 }, (_, i) => {
    const m = (startMonth + i) % 12;
    const y = startYear + Math.floor((startMonth + i) / 12);
    const cuotas = activeDebts
      .filter(d => i < d.remainingInstallments)
      .map(d => ({ name: d.name, amount: d.installment, color: DEBT_COLORS[activeDebts.indexOf(d) % DEBT_COLORS.length] }));
    const totalCuotas = cuotas.reduce((s, c) => s + c.amount, 0);
    const totalGasto = budgetTotal + totalCuotas;
    const balance = avgIncome - totalGasto;
    return { m, y, label: MONTH_NAMES[m], year: y, cuotas, totalCuotas, budgetTotal, totalGasto, balance };
  });

  const maxGasto = Math.max(...months.map(mo => mo.totalGasto), avgIncome, 1);

  return (
    <div style={{ display: "flex", flexDirection: "column", gap: 20 }}>

      {/* KPIs */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(170px, 1fr))", gap: 14 }}>
        {[
          { label: "Ingreso estimado", value: avgIncome, color: COLORS.text, icon: "üìà", sub: avgIncome > 0 ? "Prom. √∫ltimos 3 meses" : "Sin ingresos registrados" },
          { label: "Gastos fijos", value: budgetTotal, color: COLORS.text, icon: "üè∑Ô∏è", sub: `${budgetItems.length} categor√≠as` },
          { label: "Cuotas este mes", value: months[0].totalCuotas, color: COLORS.text, icon: "üí≥", sub: `${months[0].cuotas.length} cuota(s)` },
          { label: "Compromiso total", value: months[0].totalGasto, color: COLORS.text, icon: "üìä", sub: "Fijos + cuotas" },
          ...(avgIncome > 0 ? [{ label: "Balance estimado", value: months[0].balance, color: COLORS.text, icon: months[0].balance >= 0 ? "‚úÖ" : "‚ö†Ô∏è", sub: months[0].balance >= 0 ? "Super√°vit" : "D√©ficit" }] : []),
        ].map(k => (
          <Card key={k.label} style={{ padding: 18 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
              <div style={{ fontSize: 11, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px" }}>{k.label}</div>
              <span style={{ fontSize: 18 }}>{k.icon}</span>
            </div>
            <div style={{ fontSize: 22, fontWeight: 700, color: k.color, fontFamily: "'Instrument Serif', Georgia, serif" }}>{formatFull(k.value)}</div>
            <div style={{ fontSize: 11, color: COLORS.textMuted, marginTop: 4 }}>{k.sub}</div>
          </Card>
        ))}
      </div>

      {/* Tips si faltan datos */}
      {avgIncome === 0 && (
        <div style={{ background: COLORS.accentDim, border: `1px solid ${COLORS.accent}40`, borderRadius: 12, padding: 14, fontSize: 13, color: COLORS.accent }}>
          üí° Registr√° ingresos en <strong>Transacciones</strong> para ver tu balance mensual estimado.
        </div>
      )}
      {activeDebts.length === 0 && (
        <div style={{ background: COLORS.purpleDim, border: `1px solid ${COLORS.purple}40`, borderRadius: 12, padding: 14, fontSize: 13, color: COLORS.purple }}>
          üí≥ Agreg√° deudas en cuotas en la pesta√±a <strong>Deudas</strong> (con cuota mensual y cuotas restantes) para verlas en la proyecci√≥n.
        </div>
      )}

      {/* ‚îÄ‚îÄ‚îÄ L√çNEA DE TIEMPO ‚îÄ‚îÄ‚îÄ */}
      <Card style={{ padding: 0, overflow: "hidden" }}>
        <div style={{ padding: "18px 22px", borderBottom: `1px solid ${COLORS.border}`, fontWeight: 700, fontSize: 15, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span>üìÖ L√≠nea de tiempo ‚Äî 12 meses</span>
          <span style={{ fontSize: 12, color: COLORS.textMuted, fontWeight: 400 }}>Hac√© click en un mes para ver el detalle</span>
        </div>

        {/* Leyenda */}
        <div style={{ padding: "12px 22px", borderBottom: `1px solid ${COLORS.border}`, display: "flex", flexWrap: "wrap", gap: 8 }}>
          {budgetItems.length > 0 && (
            <span style={{ background: COLORS.accent+"22", color: COLORS.accent, borderRadius: 20, padding: "3px 10px", fontSize: 11, fontWeight: 600 }}>
              üè∑Ô∏è Gastos fijos ({formatFull(budgetTotal)})
            </span>
          )}
          {activeDebts.map((d, i) => (
            <span key={d.id} style={{ background: DEBT_COLORS[i % DEBT_COLORS.length]+"22", color: DEBT_COLORS[i % DEBT_COLORS.length], borderRadius: 20, padding: "3px 10px", fontSize: 11, fontWeight: 600 }}>
              üí≥ {d.name} ({formatFull(d.installment)}/mes ¬∑ {d.remainingInstallments}c restantes)
            </span>
          ))}
          {avgIncome > 0 && (
            <span style={{ background: COLORS.green+"22", color: COLORS.green, borderRadius: 20, padding: "3px 10px", fontSize: 11, fontWeight: 600 }}>
              üìà Ingreso prom. {formatFull(avgIncome)}
            </span>
          )}
        </div>

        {/* Meses */}
        {months.map((mo, i) => {
          const isHoy = i === 0;
          const abierto = expandido === i;
          const pctTotal = (mo.totalGasto / maxGasto) * 100;
          const pctBudget = (mo.budgetTotal / maxGasto) * 100;
          const isDeficit = avgIncome > 0 && mo.balance < 0;

          return (
            <div key={i}>
              {/* Fila principal clickeable */}
              <div
                onClick={() => setExpandido(abierto ? null : i)}
                style={{
                  display: "flex", alignItems: "center", gap: 0,
                  borderBottom: `1px solid ${COLORS.border}`,
                  background: isHoy ? "#3ecfaa08" : abierto ? "#ffffff05" : "transparent",
                  cursor: "pointer", transition: "background .15s",
                }}
              >
                {/* Indicador lateral */}
                <div style={{
                  width: 4, alignSelf: "stretch", flexShrink: 0,
                  background: isHoy ? COLORS.accent : isDeficit ? COLORS.red : COLORS.green,
                }} />

                {/* Contenido */}
                <div style={{ flex: 1, padding: "14px 18px", display: "flex", alignItems: "center", gap: 16 }}>

                  {/* Mes + a√±o */}
                  <div style={{ width: 54, flexShrink: 0 }}>
                    <div style={{ fontSize: 15, fontWeight: 700, color: isHoy ? COLORS.accent : COLORS.text }}>{mo.label}</div>
                    <div style={{ fontSize: 11, color: COLORS.textMuted }}>{mo.year}{isHoy ? " ¬∑ hoy" : ""}</div>
                  </div>

                  {/* Barra apilada */}
                  <div style={{ flex: 1, display: "flex", flexDirection: "column", gap: 5 }}>
                    <div style={{ display: "flex", height: 22, borderRadius: 6, overflow: "hidden", background: COLORS.bg }}>
                      {/* Presupuesto fijo */}
                      {mo.budgetTotal > 0 && (
                        <div style={{ width: `${pctBudget}%`, background: COLORS.accent, opacity: 0.8, transition: "width .4s" }} />
                      )}
                      {/* Cada cuota como segmento */}
                      {mo.cuotas.map((c, ci) => (
                        <div key={c.name} style={{
                          width: `${(c.amount / maxGasto) * 100}%`,
                          background: c.color, opacity: 0.85,
                          transition: "width .4s",
                          position: "relative",
                        }} />
                      ))}
                    </div>
                    {/* L√≠nea de ingreso */}
                    {avgIncome > 0 && (
                      <div style={{ position: "relative", height: 2 }}>
                        <div style={{ position: "absolute", left: 0, top: 0, bottom: 0, width: `${(avgIncome / maxGasto) * 100}%`, background: COLORS.green, borderRadius: 2 }} />
                        <div style={{ position: "absolute", left: 0, top: 0, right: 0, bottom: 0, background: COLORS.bg, borderRadius: 2, zIndex: -1 }} />
                      </div>
                    )}
                  </div>

                  {/* Totales */}
                  <div style={{ width: 140, flexShrink: 0, textAlign: "right" }}>
                    <div style={{ fontSize: 14, fontWeight: 700, color: COLORS.text }}>{formatFull(mo.totalGasto)}</div>
                    {avgIncome > 0 && (
                      <div style={{ fontSize: 12, fontWeight: 600, color: COLORS.textMuted, marginTop: 2 }}>
                        {mo.balance >= 0 ? "‚ñ≤ +" : "‚ñº "}{formatFull(mo.balance)}
                      </div>
                    )}
                    {mo.cuotas.length > 0 && (
                      <div style={{ fontSize: 10, color: COLORS.textMuted, marginTop: 2 }}>
                        {mo.cuotas.length} cuota{mo.cuotas.length > 1 ? "s" : ""}
                      </div>
                    )}
                  </div>

                  {/* Chevron */}
                  <div style={{ fontSize: 12, color: COLORS.textMuted, width: 16, flexShrink: 0 }}>
                    {abierto ? "‚ñ≤" : "‚ñº"}
                  </div>
                </div>
              </div>

              {/* Detalle expandido */}
              {abierto && (
                <div style={{ background: "#ffffff06", borderBottom: `1px solid ${COLORS.border}`, padding: "16px 22px 16px 42px" }}>
                  <div style={{ display: "flex", flexDirection: "column", gap: 8, maxWidth: 500 }}>

                    {/* T√≠tulo secci√≥n gastos fijos */}
                    {budgetItems.length > 0 && (
                      <>
                        <div style={{ fontSize: 11, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px", marginBottom: 4 }}>
                          üè∑Ô∏è Gastos fijos
                        </div>
                        {budgetItems.map(b => (
                          <div key={b.cat} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", fontSize: 13 }}>
                            <span style={{ color: COLORS.textMuted }}>{CATEGORY_ICONS[b.cat] || "üì¶"} {b.cat}</span>
                            <span style={{ color: COLORS.text, fontWeight: 600 }}>{formatFull(b.limit)}</span>
                          </div>
                        ))}
                        <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, borderTop: `1px solid ${COLORS.border}`, paddingTop: 8, marginTop: 2 }}>
                          <span style={{ color: COLORS.text, fontWeight: 600 }}>Subtotal fijos</span>
                          <span style={{ color: COLORS.text, fontWeight: 700 }}>{formatFull(mo.budgetTotal)}</span>
                        </div>
                      </>
                    )}

                    {/* Cuotas */}
                    {mo.cuotas.length > 0 && (
                      <>
                        <div style={{ fontSize: 11, color: COLORS.textMuted, fontWeight: 600, textTransform: "uppercase", letterSpacing: ".5px", marginBottom: 4, marginTop: budgetItems.length > 0 ? 12 : 0 }}>
                          üí≥ Cuotas activas
                        </div>
                        {mo.cuotas.map((c, ci) => {
                          const debt = activeDebts.find(d => d.name === c.name);
                          const cuotaNum = debt ? (debt.remainingInstallments - (months.findIndex(mo2 => mo2.cuotas.find(c2 => c2.name === c.name)) + i)) : "?";
                          return (
                            <div key={c.name} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", fontSize: 13 }}>
                              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <div style={{ width: 10, height: 10, borderRadius: "50%", background: c.color, flexShrink: 0 }} />
                                <span style={{ color: COLORS.textMuted }}>{c.name}</span>
                                <span style={{ fontSize: 10, color: COLORS.textMuted }}>({debt ? debt.remainingInstallments - i : "?"} restantes)</span>
                              </div>
                              <span style={{ color: c.color, fontWeight: 600 }}>{formatFull(c.amount)}</span>
                            </div>
                          );
                        })}
                        <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, borderTop: `1px solid ${COLORS.border}`, paddingTop: 8, marginTop: 2 }}>
                          <span style={{ color: COLORS.text, fontWeight: 600 }}>Subtotal cuotas</span>
                          <span style={{ color: COLORS.text, fontWeight: 700 }}>{formatFull(mo.totalCuotas)}</span>
                        </div>
                      </>
                    )}

                    {/* Total del mes */}
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: 15, fontWeight: 700, background: COLORS.bg, borderRadius: 10, padding: "10px 14px", marginTop: 8 }}>
                      <span>Total comprometido</span>
                      <span style={{ color: COLORS.text }}>{formatFull(mo.totalGasto)}</span>
                    </div>

                    {/* Balance */}
                    {avgIncome > 0 && (
                      <div style={{ display: "flex", justifyContent: "space-between", fontSize: 14, fontWeight: 700, background: mo.balance >= 0 ? COLORS.greenDim : COLORS.redDim, borderRadius: 10, padding: "10px 14px", border: `1px solid ${mo.balance >= 0 ? COLORS.green : COLORS.red}40` }}>
                        <span style={{ color: COLORS.text }}>
                          {mo.balance >= 0 ? "‚úÖ Te sobra" : "‚ö†Ô∏è Te falta"}
                        </span>
                        <span style={{ color: COLORS.text }}>
                          {mo.balance >= 0 ? "+" : ""}{formatFull(mo.balance)}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </Card>
    </div>
  );
}


const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<FinanzasApp />);

  </script>
</body>
</html>